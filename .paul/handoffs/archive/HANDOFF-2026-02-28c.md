# PAUL Handoff

**Date:** 2026-02-28
**Status:** paused â€” Plan 01-02 created, APPLY not yet run

---

## READ THIS FIRST

You have no prior context. This document tells you everything.

**Project:** axon â€” Codebase Intelligence Graph
**Core value:** Developers and AI agents can instantly understand any codebase â€” files auto-indexed, agents query the DB to reduce token usage and improve quality.

---

## Current State

**Version:** 0.4.0 (v0.5 in progress)
**Milestone:** v0.5 Hardening â€” ðŸš§ In Progress
**Phase:** 1 of 2 â€” Test Quality & Bug Fixes
**Plan:** 01-02 â€” PLAN created, awaiting APPLY

**Loop Position:**
```
PLAN â”€â”€â–¶ APPLY â”€â”€â–¶ UNIFY
  âœ“        â—‹        â—‹     [Plan ready to execute]
```

---

## What Was Done This Session

- **Plan 01-01 UNIFY completed** â€” created `.paul/phases/01-test-quality-bugs/01-01-SUMMARY.md`
  - AC-1 PASS: events.jsonl isolation via autouse conftest.py fixture âœ“
  - AC-2/AC-3 FAIL: root cause was KuzuDB init overhead (4-5s/test), not fastembed
  - Corrected root cause documented in SUMMARY
- **Decision made:** Option A â€” session-scoped KuzuDB fixture (not mock, not Phase 2)
- **Plan 01-02 created** at `.paul/phases/01-test-quality-bugs/01-02-PLAN.md`
- **Handoff HANDOFF-2026-02-28b.md archived** to `.paul/handoffs/archive/`

---

## What's In Progress

**Plan 01-02 PLAN.md exists, APPLY not started.**

The plan has 3 tasks:

**Task 1 â€” Fix flaky async embeddings race (test_pipeline.py)**
- `test_async_embeddings_returns_future`: move `result.embedding_future.result(timeout=10)` INSIDE the `with patch()` block
- Simple code fix, well-diagnosed

**Task 2 â€” Session-scoped KuzuDB schema template (conftest.py + test_pipeline.py)**
- Add `kuzu_template` session fixture to `conftest.py` â€” creates empty schema'd KuzuDB once per session
- Update `storage` and `rich_storage` fixtures in `test_pipeline.py` to `shutil.copytree(template)` instead of calling `initialize()` from scratch
- Saves ~4s Ã— 18 tests = 72s â†’ target: test_pipeline.py < 100s (was ~166s)

**Task 3 â€” Session pre-indexed watcher template (conftest.py + test_watcher.py)**
- Add `watcher_indexed_template` session fixture â€” runs pipeline ONCE on watcher repo structure, yields the indexed DB path
- Update `storage` fixture in `test_watcher.py` to copy from watcher template
- Remove `run_pipeline(tmp_repo, storage, embeddings=False)` from 8 test bodies (3 in TestReindexFiles, 5 in TestWatcherReindexFiles)
- Saves ~10s Ã— 8 tests = 80s â†’ target: test_watcher.py < 15s (was ~102s) âœ“

**Key insight:** The <20s target from Plan 01-01 for test_pipeline.py was based on the wrong hypothesis. With real KuzuDB integration tests, <100s is the correct achievable target.

---

## What's Next

**Immediate:**
```
/paul:apply .paul/phases/01-test-quality-bugs/01-02-PLAN.md
```
Execute the 3-task plan. All tasks are autonomous (no checkpoints).

**After that:**
- Run `/paul:unify .paul/phases/01-test-quality-bugs/01-02-PLAN.md`
- If AC-2/AC-3 both pass â†’ Phase 1 likely complete â†’ transition to Phase 2
- Phase 2: Elixir `use` parser + community detection parallelization

---

## Key Files

| File | Purpose |
|------|---------|
| `.paul/STATE.md` | Live project state |
| `.paul/ROADMAP.md` | Milestone overview |
| `.paul/phases/01-test-quality-bugs/01-02-PLAN.md` | **Current plan â€” needs APPLY** |
| `.paul/phases/01-test-quality-bugs/01-01-SUMMARY.md` | Prior plan UNIFY â€” root cause correction documented |
| `tests/core/conftest.py` | Existing autouse fixture (will gain 2 session fixtures) |
| `tests/core/test_pipeline.py` | 18 tests (storage fixtures need update) |
| `tests/core/test_watcher.py` | 12 tests (storage fixture + 8 setup calls need update) |

---

## Important Context

- `create_schema()` in `kuzu_schema.py` uses `IF NOT EXISTS` throughout â€” idempotent âœ“
- Copying a closed KuzuDB directory (`shutil.copytree`) produces a valid, openable DB âœ“
- Session fixtures must use `tmp_path_factory` (not `tmp_path`, which is function-scoped)
- `watcher_indexed_template` must patch `Path.home()` via `unittest.mock.patch` (not monkeypatch, which is function-scoped)
- DB stores paths as relative (e.g. `src/app.py`) â€” copied DB works with any `tmp_path` as repo root âœ“

---

## Resume Instructions

1. Run `/paul:resume` â€” reads STATE.md, routes to APPLY
2. Approve the APPLY
3. After APPLY: run `/paul:unify .paul/phases/01-test-quality-bugs/01-02-PLAN.md`

---

*Handoff created: 2026-02-28*
