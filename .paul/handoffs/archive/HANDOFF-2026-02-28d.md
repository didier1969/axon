# PAUL Handoff

**Date:** 2026-02-28
**Status:** paused â€” Phase 1 complete, Phase 2 not yet started

---

## READ THIS FIRST

You have no prior context. This document tells you everything.

**Project:** axon â€” Codebase Intelligence Graph
**Core value:** Developers and AI agents can instantly understand any codebase â€” files auto-indexed, agents query the DB to reduce token usage and improve quality.

---

## Current State

**Version:** 0.4.0 (v0.5 in progress)
**Milestone:** v0.5 Hardening â€” ðŸš§ In Progress
**Phase:** 2 of 2 â€” Parser & Performance (not started)
**Plan:** none yet

**Loop Position:**
```
PLAN â”€â”€â–¶ APPLY â”€â”€â–¶ UNIFY
  â—‹        â—‹        â—‹     [Phase 2 not started â€” ready for /paul:plan]
```

---

## What Was Done This Session

**Phase 1 complete** â€” committed as `47758ae`

### Plan 01-01 (prior session, already done)
- `autouse` conftest fixture: redirects `Path.home()` to `tmp_path` for every test
- Prevents events.jsonl pollution in real `~/.axon/` during test runs

### Plan 01-02 (this session)
- **Async race fix**: moved `result.embedding_future.result(timeout=10)` inside `with patch()` block in `test_async_embeddings_returns_future` â€” mock stays active during thread resolution
- **`kuzu_template` session fixture** in `tests/core/conftest.py`: schema-initialized KuzuDB created once per session; per-test `storage` fixtures use `shutil.copy2` (not `copytree` â€” KuzuDB is a single file)
- **`watcher_indexed_template` session fixture**: pre-indexed DB with `src/app.py` + `src/utils.py` created once per session via `patch.object(Path, "home")`
- **8 `run_pipeline()` calls removed** from `test_watcher.py` test bodies

### Results
- `test_pipeline.py`: 166s â†’ **81s** âœ… (target < 100s)
- `test_watcher.py`: 102s â†’ **28s** âœ… (target was 15s; 28s is the floor given ~1.3s KuzuDB open per test)
- 752/752 tests pass

### Watcher Hotfix (bonus)
`_run_global_phases()` in `watcher.py` was calling `run_pipeline(full=True)` with embeddings every 30s â€” loading fastembed and embedding all symbols on every timer tick. Fixed:
- `embeddings=False` in `_run_global_phases`
- Added `last_embed` timer â€” embeddings now fire at `EMBEDDING_INTERVAL` (60s) when dirty

---

## What's In Progress

Nothing. Session ended cleanly at UNIFY complete.

---

## What's Next

**Immediate:**
```
/paul:plan
```
Phase 2 â€” Parser & Performance. Two independent work items:

**1. Elixir `use` parser**
- Currently: Elixir `use Module` macro calls are ignored â†’ no heritage relationship â†’ warnings on every Elixir project
- Goal: Parse `use Module` â†’ create `USES` or `HERITAGE` relationship in graph
- File to modify: `src/axon/core/parsers/elixir_parser.py` (or equivalent)

**2. Community detection parallelization**
- Currently: Sequential community detection (Louvain) â†’ 19% of cold-start time
- Goal: Parallelize across connected components or use a parallel algorithm
- File: `src/axon/core/ingestion/community.py` (or equivalent)

---

## Key Files

| File | Purpose |
|------|---------|
| `.paul/STATE.md` | Live project state |
| `.paul/ROADMAP.md` | Milestone overview |
| `.paul/phases/01-test-quality-bugs/01-02-SUMMARY.md` | Phase 1 plan 02 summary |
| `tests/core/conftest.py` | Session fixtures (kuzu_template, watcher_indexed_template) |
| `tests/core/test_pipeline.py` | Pipeline tests |
| `tests/core/test_watcher.py` | Watcher tests |
| `src/axon/core/ingestion/watcher.py` | Watch mode (hotfix applied) |

---

## Important Context

- KuzuDB creates a **single file** at the given path (not a directory) â€” use `shutil.copy2` not `copytree`
- Session fixtures that need `Path.home()` isolation must use `unittest.mock.patch.object` (not `monkeypatch`, which is function-scoped)
- `create_schema()` uses `IF NOT EXISTS` throughout â€” idempotent, safe to call on existing DB
- test_watcher.py at 28s is the realistic floor â€” accepted, not worth mocking KuzuDB

---

## Resume Instructions

1. Run `/paul:resume` â€” reads STATE.md, routes to Phase 2 plan
2. Approve â†’ `/paul:plan` for Phase 2

---

*Handoff created: 2026-02-28*
