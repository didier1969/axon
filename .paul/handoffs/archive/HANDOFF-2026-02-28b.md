# PAUL Handoff

**Date:** 2026-02-28
**Status:** paused â€” APPLY incomplete, stopped before UNIFY

---

## READ THIS FIRST

You have no prior context. This document tells you everything.

**Project:** axon â€” Codebase Intelligence Graph
**Core value:** Developers and AI agents can instantly understand any codebase â€” files auto-indexed, agents query the DB to reduce token usage and improve quality.

---

## Current State

**Version:** 0.4.0 (v0.5 in progress)
**Milestone:** v0.5 Hardening â€” ðŸš§ In Progress
**Phase:** 1 of 2 â€” Test Quality & Bug Fixes
**Plan:** 01-01 â€” APPLY executed, UNIFY not run yet

**Loop Position:**
```
PLAN â”€â”€â–¶ APPLY â”€â”€â–¶ UNIFY
  âœ“        âœ“        â—‹     [Apply complete, UNIFY pending]
```

---

## What Was Done This Session

- **Milestone v0.5 Hardening created** â€” 2 phases defined in ROADMAP.md
- **Plan 01-01 created** at `.paul/phases/01-test-quality-bugs/01-01-PLAN.md`
- **conftest.py created** at `tests/core/conftest.py` â€” autouse fixture that patches `Path.home()` â†’ `tmp_path` for all tests; this WORKS and prevents events.jsonl pollution
- **test_pipeline.py patched** â€” added `embeddings=False` to 8 non-embedding `run_pipeline()` calls
- **test_watcher.py patched** â€” added `embeddings=False` to all 8 setup `run_pipeline()` calls
- **Verified**: events.jsonl stayed at 191 lines after running full test suite (AC-1 confirmed)
- **Verified**: test_analytics.py 6 passed in 0.06s (AC-4 confirmed)

---

## What's In Progress

**Plan 01-01 APPLY partially successful but performance targets missed:**

The plan had 3 ACs around performance:
- AC-2: test_pipeline.py < 20s â€” âœ— still ~166s
- AC-3: test_watcher.py < 15s â€” âœ— still ~90-102s

**Root cause discovered (different from plan diagnosis):**
The slowness is NOT from fastembed background threads. Profiling revealed:
- `KuzuBackend.initialize()` takes **4-5s per test in fixture setup** (creates new KuzuDB on disk)
- `run_pipeline()` + `bulk_load()` takes **5-7s per test call** for even tiny 2-3 file repos
- `embeddings=False` didn't help because embeddings are NOT the bottleneck
- KuzuDB initialization overhead is the real issue (18 tests Ã— 5s setup â‰ˆ 90s just from setup)

**The flaky async embeddings race condition** (test_async_embeddings_returns_future) was correctly identified: the `with patch()` context exits before the background thread runs embed_graph, so the real fastembed loads. Fix: move `result.embedding_future.result(timeout=10)` INSIDE the `with patch()` block.

---

## Key Decision for Next Session

Before running UNIFY, decide: **what to do about test performance?**

**Option A â€” Plan 01-02: Session-scoped KuzuDB fixture**
Create a session-scoped pre-initialized KuzuDB template that's copied (not re-created) per test.
- Saves 4-5s per test Ã— 30 tests = 2-2.5 minutes
- Requires careful fixture design for test isolation
- Tests remain true integration tests

**Option B â€” Accept partial win, move to Phase 2**
- AC-1 (events.jsonl) is fixed âœ“
- The test slowness is a known limitation of KuzuDB overhead
- Move to Phase 2 (Elixir `use` parser + community detection parallelization)
- Log performance as a deferred issue

**Option C â€” Mock KuzuDB in tests**
- Replace real KuzuBackend with a mock for pipeline tests
- Fastest tests but loses integration test value

---

## What's Next

**Immediate:**
```
/paul:unify .paul/phases/01-test-quality-bugs/01-01-PLAN.md
```
Reconcile plan vs actual. Record the diagnosis correction. Choose Option A, B, or C.

**After that:**
- If A: create Plan 01-02 for session-scoped fixtures
- If B: move to `/paul:plan` for Phase 2 (Parser & Performance)

---

## Files Modified This Session

| File | Change |
|------|--------|
| `tests/core/conftest.py` | CREATED â€” autouse `isolated_axon_home` fixture |
| `tests/core/test_pipeline.py` | 8 `run_pipeline()` calls â†’ added `embeddings=False` |
| `tests/core/test_watcher.py` | 8 `run_pipeline()` calls â†’ added `embeddings=False` (replace_all) |
| `.paul/STATE.md` | Updated with v0.5 state |
| `.paul/ROADMAP.md` | v0.5 Hardening milestone added |

## Key Files

| File | Purpose |
|------|---------|
| `.paul/STATE.md` | Live project state |
| `.paul/ROADMAP.md` | Milestone overview |
| `.paul/phases/01-test-quality-bugs/01-01-PLAN.md` | Current plan â€” needs UNIFY |

---

## Resume Instructions

1. Run `/paul:resume` â€” reads STATE.md and routes to UNIFY
2. In UNIFY: decide on Option A/B/C for test performance
3. If Option A: run `/paul:plan` for Plan 01-02
4. If Option B: run `/paul:plan` for Phase 2

---

*Handoff created: 2026-02-28*
