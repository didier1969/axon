---
phase: 01-consolidation-and-scale
plan: 04
type: execute
wave: 1
depends_on: ["01-03"]
files_modified:
  - src/axon/mcp/tools.py
  - src/axon/mcp/server.py
  - src/axon/core/analytics.py
  - src/axon/core/ingestion/pipeline.py
  - src/axon/cli/main.py
  - tests/mcp/test_tools.py
  - tests/core/test_analytics.py
  - tests/cli/test_main.py
autonomous: true
---

<objective>
## Goal
Add multi-repo MCP query routing, usage analytics event logging, and `axon stats` CLI command.

## Purpose
Enables AI agents to query any indexed repo by name (not just the cwd repo), creates a usage history for observability, and surfaces that history via `axon stats` — completing the v0.4 milestone.

## Output
- `axon_query`, `axon_context`, `axon_impact` accept optional `repo` parameter
- `~/.axon/events.jsonl` accumulates events on every MCP query and `axon analyze` run
- `axon stats` CLI command reads and displays aggregated usage metrics
</objective>

<context>
## Project Context
@.paul/PROJECT.md
@.paul/STATE.md

## Prior Work
@.paul/phases/01-consolidation-and-scale/01-03-SUMMARY.md

## Source Files
@src/axon/mcp/tools.py
@src/axon/mcp/server.py
@src/axon/cli/main.py
@src/axon/core/ingestion/pipeline.py
</context>

<acceptance_criteria>

## AC-1: Multi-repo query routing
```gherkin
Given at least one repo is registered in ~/.axon/repos/
When axon_query (or axon_context / axon_impact) is called with repo="my-project"
Then it loads that repo's KuzuBackend from ~/.axon/repos/my-project/meta.json → path/.axon/kuzu
  And queries it instead of the cwd storage
  And returns an error string if the repo slug is not found
```

## AC-2: Usage analytics event logging
```gherkin
Given the ~/.axon/ directory exists
When axon_query, axon_context, or axon_impact MCP tools are called
  Or axon analyze / run_pipeline completes
Then a JSON line is appended to ~/.axon/events.jsonl
  And the line includes ts (ISO 8601), type ("query" or "index"), repo name, and relevant metrics
  And a logging failure never raises or interrupts the caller
```

## AC-3: axon stats CLI command
```gherkin
Given ~/.axon/events.jsonl has at least one event
When the user runs axon stats
Then it prints total query count, unique queries, top 5 queries, total index runs, and last activity per repo
  And when events.jsonl does not exist it prints a "no usage data" message and exits 0
```

## AC-4: No regressions
```gherkin
Given the existing test suite (750 tests)
When all tests are run after the changes
Then all tests pass with 0 failures
```

</acceptance_criteria>

<tasks>

<task type="auto">
  <name>Task 1: Multi-repo MCP query routing</name>
  <files>src/axon/mcp/tools.py, src/axon/mcp/server.py, tests/mcp/test_tools.py</files>
  <action>
    In tools.py:
    - Add `_load_repo_storage(repo: str) -> StorageBackend | None` function:
      - Read `Path.home() / ".axon" / "repos" / repo / "meta.json"`
      - Parse JSON, get `path` key
      - Open `KuzuBackend()`, call `storage.initialize(Path(path) / ".axon" / "kuzu", read_only=True)`
      - Return the backend; return `None` and log warning on any OSError, JSONDecodeError, or RuntimeError
    - Add optional `repo: str | None = None` parameter to `handle_query`, `handle_context`, `handle_impact`
    - At the top of each handler, if `repo` is not None:
      - Call `_load_repo_storage(repo)` → if None, return f"Repository '{repo}' not found in registry."
      - Assign the result to a local variable `storage` that shadows the param
      - After the handler logic, call `storage.close()` on the repo-specific backend (use try/finally)
    - Avoid: modifying handle_dead_code, handle_detect_changes, handle_cypher (cwd-only is fine)
    - Avoid: caching repo storages — open/close per request is safe for read-only

    In server.py:
    - In `_dispatch_tool`, extract `repo = arguments.get("repo")` and pass to handle_query, handle_context, handle_impact
    - In TOOLS list, add `repo` property to axon_query, axon_context, axon_impact inputSchema:
      ```json
      "repo": {
        "type": "string",
        "description": "Name of an indexed repository to query (from axon_list_repos). Defaults to current directory."
      }
      ```

    In tests/mcp/test_tools.py:
    - Add test: handle_query with repo="nonexistent" returns "not found" message (no storage needed)
    - Add test: _load_repo_storage with missing meta.json returns None
    - Add test: _load_repo_storage with valid meta.json (tmp_path fixture) returns a backend path
  </action>
  <verify>uv run pytest tests/mcp/test_tools.py -v -k "repo"</verify>
  <done>AC-1 satisfied: repo param routes to alternate storage; missing repo returns error string</done>
</task>

<task type="auto">
  <name>Task 2: Usage analytics event logging</name>
  <files>src/axon/core/analytics.py, src/axon/mcp/tools.py, src/axon/core/ingestion/pipeline.py, tests/core/test_analytics.py</files>
  <action>
    Create src/axon/core/analytics.py:
    - Single public function: `log_event(type: str, **kwargs: Any) -> None`
    - Builds dict: `{"ts": datetime.now(tz=timezone.utc).isoformat(), "type": type, **kwargs}`
    - Appends as JSON line to `Path.home() / ".axon" / "events.jsonl"`
    - Creates parent dirs with `mkdir(parents=True, exist_ok=True)` before writing
    - Wraps everything in `try/except Exception` and calls `logger.debug(...)` on failure — NEVER raises
    - Use file open with mode "a", encoding="utf-8"

    In src/axon/mcp/tools.py:
    - Import `from axon.core.analytics import log_event`
    - In `handle_query`: after results are computed, call:
      `log_event("query", query=query[:200], results=len(results), language=language or "", repo=repo or "")`
    - In `handle_context`: after result is computed, call:
      `log_event("context", symbol=symbol[:200], repo=repo or "")`
    - In `handle_impact`: after result is computed, call:
      `log_event("impact", symbol=symbol[:200], repo=repo or "")`

    In src/axon/core/ingestion/pipeline.py:
    - Import `from axon.core.analytics import log_event`
    - After `run_pipeline` returns its result, call:
      `log_event("index", repo=repo_path.name, files=result.files, symbols=result.symbols, duration=round(result.duration_seconds, 2))`
    - Place this call inside the `run_pipeline` function, right before the return, inside a try/except to never block

    Create tests/core/test_analytics.py:
    - test_log_event_creates_file: call log_event("query", query="test"), assert events.jsonl exists and has valid JSON line
    - test_log_event_appends: call log_event twice, assert two lines
    - test_log_event_never_raises: patch open to raise OSError, assert log_event does not raise
    - test_log_event_fields: verify ts, type, and extra kwargs appear in output
    - Use tmp_path fixture + monkeypatch Path.home() to point to tmp dir
  </action>
  <verify>uv run pytest tests/core/test_analytics.py -v</verify>
  <done>AC-2 satisfied: events.jsonl grows on each MCP call; errors are silently swallowed</done>
</task>

<task type="auto">
  <name>Task 3: axon stats CLI command</name>
  <files>src/axon/cli/main.py, tests/cli/test_main.py</files>
  <action>
    In src/axon/cli/main.py, add a new `stats` command:
    ```python
    @app.command()
    def stats() -> None:
        """Show axon usage statistics from event log."""
    ```
    Implementation:
    - Read `Path.home() / ".axon" / "events.jsonl"`
    - If file does not exist: `console.print("No usage data found. Run 'axon analyze' or 'axon query' to generate stats.")` and return
    - Parse lines: `events = [json.loads(line) for line in f if line.strip()]`, skip lines that fail to parse
    - Separate query events (type in {"query","context","impact"}) from index events (type == "index")
    - Print with rich:
      ```
      [bold]Axon Usage Statistics[/bold]

        Queries:       {total_query_count}
        Unique queries: {len(unique_query_texts)}
        Index runs:    {index_count}

      [bold]Top 5 queries:[/bold]
        1. "..." (N times)
        ...

      [bold]Per-repo index activity:[/bold]
        repo-name  — {N} runs, last: {ISO timestamp}
      ```
    - Handle empty events list gracefully (print zeros, not crash)

    In tests/cli/test_main.py:
    - test_stats_no_file: CliRunner().invoke(app, ["stats"]) → output contains "No usage data"
    - test_stats_with_events: write events.jsonl to tmp dir, monkeypatch Path.home(), invoke stats → shows counts
    - test_stats_skips_bad_lines: mix valid JSON with a corrupt line → no exception, valid events counted
  </action>
  <verify>uv run pytest tests/cli/test_main.py -v -k "stats" && uv run axon stats --help</verify>
  <done>AC-3 satisfied: axon stats reads events.jsonl and displays aggregated metrics</done>
</task>

</tasks>

<boundaries>

## DO NOT CHANGE
- src/axon/core/parsers/* (parser work complete from 01-03)
- src/axon/core/storage/* (backend stable from 01-02)
- src/axon/config/* (language config stable)
- Any existing MCP tool behavior when `repo` is not provided (backward compatible)

## SCOPE LIMITS
- No persistence of query results or caching of repo backends
- No analytics dashboard or HTTP interface — CLI only
- events.jsonl is local to the machine, no remote sync
- Do not add event logging to watch mode or watcher (only analyze + MCP)

</boundaries>

<verification>
Before declaring plan complete:
- [ ] uv run pytest tests/ -x -q (all 750+ tests pass, 0 failures)
- [ ] uv run axon stats --help (command registered and shows help text)
- [ ] uv run axon list (existing list command still works)
- [ ] All acceptance criteria met (AC-1 through AC-4)
</verification>

<success_criteria>
- All 3 tasks completed
- Multi-repo routing: axon_query/context/impact accept optional `repo` arg
- Analytics: events.jsonl populated on query and index events, never blocks
- Stats: `axon stats` prints aggregated metrics from events.jsonl
- No regressions: full test suite passes
</success_criteria>

<output>
After completion, create `.paul/phases/01-consolidation-and-scale/01-04-SUMMARY.md`
</output>
