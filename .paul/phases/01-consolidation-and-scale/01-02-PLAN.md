---
phase: 01-consolidation-and-scale
plan: 02
type: execute
wave: 1
depends_on: ["01-01"]
files_modified:
  - src/axon/core/storage/kuzu_backend.py
  - src/axon/core/storage/kuzu_schema.py
  - src/axon/core/storage/kuzu_search.py
  - src/axon/core/storage/kuzu_bulk.py
  - src/axon/core/storage/__init__.py
  - src/axon/mcp/tools.py
  - src/axon/mcp/resources.py
  - src/axon/cli/main.py
  - src/axon/core/ingestion/parser_phase.py
  - src/axon/core/ingestion/pipeline.py
  - pyproject.toml
  - tests/core/test_kuzu_backend.py
autonomous: true
---

<objective>
## Goal
Replace bare `except Exception` with specific exception types across the codebase, split kuzu_backend.py (980 LOC) into focused modules, and bump version from 0.2.3 to 0.4.0.

## Purpose
Bare `except Exception` silently swallows errors, making debugging impossible. The 980-line backend file mixes schema setup, CRUD, search, embeddings, and bulk operations into a single class. Splitting it improves maintainability without changing the public API. Version bump reflects the v0.4 milestone.

## Output
- kuzu_backend.py reduced to ~350 LOC (orchestration + CRUD)
- 3 new internal modules extracted (schema, search, bulk)
- All `except Exception` replaced with specific types (`kuzu.RuntimeError`, `OSError`, `ValueError`)
- pyproject.toml version = "0.4.0"
- All 687+ tests still pass
</objective>

<context>
## Project Context
@.paul/PROJECT.md
@.paul/ROADMAP.md
@.paul/STATE.md

## Prior Work
@.paul/phases/01-consolidation-and-scale/01-01-SUMMARY.md
Plan 01-01 added batch insert methods to kuzu_backend.py — those move into the bulk module.

## Source Files
@src/axon/core/storage/kuzu_backend.py
@src/axon/core/storage/base.py
@src/axon/core/storage/__init__.py
@src/axon/mcp/tools.py
@src/axon/mcp/resources.py
@src/axon/cli/main.py
@src/axon/core/ingestion/parser_phase.py
@src/axon/core/ingestion/pipeline.py
</context>

<acceptance_criteria>

## AC-1: No bare `except Exception` remains
```gherkin
Given the full source tree under src/axon/
When searching for `except Exception`
Then zero matches are found
And each former bare except uses a specific exception type (kuzu.RuntimeError, OSError, ValueError, or similar)
```

## AC-2: kuzu_backend.py split into focused modules
```gherkin
Given the storage package at src/axon/core/storage/
When listing modules
Then kuzu_schema.py exists (schema creation, FTS index setup)
And kuzu_search.py exists (exact_name_search, fts_search, fuzzy_search, vector_search)
And kuzu_bulk.py exists (bulk_load, _csv_copy, _bulk_load_nodes_csv, _bulk_load_rels_csv, _bulk_store_embeddings_csv, rebuild_fts_indexes, get_indexed_files)
And kuzu_backend.py contains only KuzuBackend class (init, CRUD, traversal, store_embeddings) delegating to the extracted modules
And KuzuBackend remains the single public class — all imports of KuzuBackend continue to work unchanged
```

## AC-3: Version bumped to 0.4.0
```gherkin
Given pyproject.toml
When reading the version field
Then it reads "0.4.0"
```

## AC-4: All existing tests pass
```gherkin
Given the changes to storage modules and exception handling
When the full test suite is run
Then all 687+ tests pass with no regressions
And no new warnings related to exception handling
```

</acceptance_criteria>

<tasks>

<task type="auto">
  <name>Task 1: Replace bare `except Exception` with specific types</name>
  <files>src/axon/core/storage/kuzu_backend.py, src/axon/mcp/tools.py, src/axon/mcp/resources.py, src/axon/cli/main.py, src/axon/core/ingestion/parser_phase.py, src/axon/core/ingestion/pipeline.py</files>
  <action>
    Replace every `except Exception` with the appropriate specific exception type:

    **kuzu_backend.py (25 occurrences):**
    - All Kuzu query/execute failures: `except (RuntimeError, kuzu.RuntimeError)` — KuzuDB raises RuntimeError on query failures
    - CSV/file operations: `except (RuntimeError, OSError)` — tempfile or CSV write can fail
    - close() cleanup: `except (RuntimeError, OSError)` — safe cleanup on shutdown

    **mcp/tools.py (3 occurrences):**
    - Line 196 (embedding query fallback): `except (RuntimeError, ValueError)` — embedding model or query can fail
    - Line 477 (symbol query): `except (RuntimeError, ValueError) as exc` — already captures exc
    - Line 524 (cypher execution): `except (RuntimeError, ValueError) as exc` — raw Cypher can fail various ways

    **mcp/resources.py (3 occurrences):**
    - All 3 are `execute_raw` calls that can fail on Kupher query: `except (RuntimeError, ValueError)`

    **cli/main.py (1 occurrence):**
    - Line 174: identify what it wraps and use specific type

    **parser_phase.py (1 occurrence):**
    - Line 130: identify what it wraps and use specific type

    **pipeline.py (1 occurrence):**
    - Line 115: identify what it wraps and use specific type

    Rules:
    - Keep the existing behavior (log + return default, or fallback)
    - Do NOT add new logging or change log levels
    - Do NOT change the logic flow — only narrow the exception type
    - If genuinely uncertain what a block can raise, use `(RuntimeError, ValueError, OSError)` — still better than bare Exception

    Avoid: catching `BaseException`, catching too-narrow types that would break fallback behavior.
  </action>
  <verify>
    grep -r "except Exception" src/axon/ — should return 0 results
    uv run python3 -m pytest tests/ -x -q — all 687+ tests pass
  </verify>
  <done>AC-1 satisfied: no bare except Exception remains in src/axon/</done>
</task>

<task type="auto">
  <name>Task 2: Split kuzu_backend.py into focused modules</name>
  <files>src/axon/core/storage/kuzu_backend.py, src/axon/core/storage/kuzu_schema.py, src/axon/core/storage/kuzu_search.py, src/axon/core/storage/kuzu_bulk.py, src/axon/core/storage/__init__.py, tests/core/test_kuzu_backend.py</files>
  <action>
    Extract internal helper modules from KuzuBackend. The class stays as the public API — extracted modules contain standalone functions that receive the kuzu.Connection as a parameter.

    **Create `kuzu_schema.py`:**
    - Move: `_create_schema()`, `_create_fts_indexes()`
    - Convert to module-level functions: `create_schema(conn)`, `create_fts_indexes(conn)`
    - Move constants: `_NODE_TABLE_NAMES`, `_NODE_PROPERTIES`, `_REL_PROPERTIES` (whatever schema constants exist)
    - KuzuBackend.initialize() calls `create_schema(self._conn)` instead of `self._create_schema()`

    **Create `kuzu_search.py`:**
    - Move: `exact_name_search()`, `fts_search()`, `fuzzy_search()`, `vector_search()`
    - Convert to module-level functions that take `conn: kuzu.Connection` as first param
    - Move helper: `_row_to_node()` (used by search and query methods — if shared, keep in kuzu_backend or a small helpers module)
    - KuzuBackend methods become thin wrappers: `def fts_search(self, ...) -> ...: return kuzu_search.fts_search(self._conn, ...)`

    **Create `kuzu_bulk.py`:**
    - Move: `bulk_load()`, `get_indexed_files()`, `rebuild_fts_indexes()`, `_csv_copy()`, `_bulk_load_nodes_csv()`, `_bulk_load_rels_csv()`, `_bulk_store_embeddings_csv()`
    - Convert to module-level functions with `conn` param
    - KuzuBackend.bulk_load() delegates to `kuzu_bulk.bulk_load(self._conn, graph)`

    **Update `kuzu_backend.py`:**
    - Keep: `__init__`, `initialize`, `close`, `add_nodes`, `add_relationships`, `remove_nodes_by_file`, `get_node`, `get_callers`, `get_callees`, `get_type_refs`, `get_callers_with_confidence`, `get_callees_with_confidence`, `traverse`, `traverse_with_depth`, `get_process_memberships`, `execute_raw`, `store_embeddings`, `_insert_node`, `_insert_relationship`, `_query_nodes`, `_query_nodes_with_confidence`, `_row_to_node`
    - Import and delegate to kuzu_schema, kuzu_search, kuzu_bulk
    - Target: ~350-400 LOC

    **Update `__init__.py`:**
    - Ensure `KuzuBackend` is still importable from `axon.core.storage`
    - Do NOT export the new internal modules publicly

    **Update tests:**
    - Tests should continue importing `KuzuBackend` — no test changes needed if the public API is preserved
    - If any tests directly tested private methods that moved, update the import path

    Rules:
    - The `KuzuBackend` class remains the ONLY public API — nobody imports kuzu_search directly
    - `_LABEL_TO_TABLE`, `_LABEL_MAP`, `_SEARCHABLE_TABLES` may need to be in a shared location (kuzu_backend.py or a constants section in kuzu_schema.py, imported where needed)
    - All extracted functions must have the same exception handling as the original methods
    - Do NOT change the StorageBackend protocol in base.py

    Avoid: creating a "utils" module. Avoid deep inheritance. Avoid changing the public API surface.
  </action>
  <verify>
    wc -l src/axon/core/storage/kuzu_backend.py — should be ~350-400 lines
    ls src/axon/core/storage/kuzu_schema.py src/axon/core/storage/kuzu_search.py src/axon/core/storage/kuzu_bulk.py — all exist
    python -c "from axon.core.storage.kuzu_backend import KuzuBackend; print('OK')" — import works
    uv run python3 -m pytest tests/core/test_kuzu_backend.py -v — all pass
    uv run python3 -m pytest tests/ -x -q — all 687+ tests pass
  </verify>
  <done>AC-2 satisfied: kuzu_backend.py split into focused modules, public API unchanged</done>
</task>

<task type="auto">
  <name>Task 3: Version bump to 0.4.0</name>
  <files>pyproject.toml</files>
  <action>
    Change version in pyproject.toml from "0.2.3" to "0.4.0".

    Check if version is referenced anywhere else (e.g., __version__ in __init__.py) and update those too.

    Avoid: changing any other field in pyproject.toml.
  </action>
  <verify>
    grep 'version = "0.4.0"' pyproject.toml — matches
    uv run python3 -c "import axon; print(axon.__version__)" — prints 0.4.0 (if __version__ exists)
  </verify>
  <done>AC-3 satisfied: version is 0.4.0</done>
</task>

</tasks>

<boundaries>

## DO NOT CHANGE
- src/axon/core/storage/base.py (StorageBackend protocol — interface stays the same)
- src/axon/core/graph/* (graph model is stable)
- src/axon/mcp/server.py (only imports KuzuBackend — path doesn't change)
- tests/e2e/* (e2e tests run as-is for regression)

## SCOPE LIMITS
- No new features — this is pure refactoring + cleanup
- No new dependencies
- No changes to behavior — only exception specificity and file organization
- No CLI changes beyond the one bare except fix
- No new tests needed (unless an existing test breaks due to import path change)
- The kuzu_backend split is internal — KuzuBackend public API is frozen

</boundaries>

<verification>
Before declaring plan complete:
- [ ] `grep -r "except Exception" src/axon/` — returns 0 results
- [ ] `wc -l src/axon/core/storage/kuzu_backend.py` — under 450 lines
- [ ] `ls src/axon/core/storage/kuzu_schema.py kuzu_search.py kuzu_bulk.py` — all exist
- [ ] `python -c "from axon.core.storage.kuzu_backend import KuzuBackend"` — works
- [ ] `grep 'version = "0.4.0"' pyproject.toml` — matches
- [ ] `uv run python3 -m pytest tests/ -x -q` — all 687+ tests pass
- [ ] No regressions in MCP server, CLI, or watcher
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- 687+ tests pass (no additions needed, no removals)
- Public API unchanged — all imports work
</success_criteria>

<output>
After completion, create `.paul/phases/01-consolidation-and-scale/01-02-SUMMARY.md`
</output>
