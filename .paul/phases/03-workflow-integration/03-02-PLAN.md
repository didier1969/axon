---
phase: 03-workflow-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/axon/cli/main.py
  - tests/cli/test_main.py
  - templates/github-actions.yml
  - templates/pre-commit-config.yaml
autonomous: true
---

<objective>
## Goal
Enable axon to serve as a CI quality gate and ship template config files users can drop into their projects to integrate axon into CI pipelines and pre-commit hooks.

## Purpose
Plan 03-01 delivered zero-friction session start (auto-start on `cd`). Plan 03-02 completes the CI side: developers can run `axon dead-code --exit-code` in CI to fail pipelines when dead code is introduced, and have copy-paste templates for GitHub Actions and pre-commit to make setup instant.

## Output
- `axon dead-code --exit-code` flag: exits 1 if dead code found, 0 if clean
- `templates/github-actions.yml` — GitHub Actions workflow users copy to `.github/workflows/axon.yml`
- `templates/pre-commit-config.yaml` — pre-commit config snippet users merge into `.pre-commit-config.yaml`
</objective>

<context>
## Project Context
@.paul/PROJECT.md
@.paul/ROADMAP.md
@.paul/STATE.md

## Prior Work
@.paul/phases/03-workflow-integration/03-01-SUMMARY.md

## Source Files
@src/axon/cli/main.py
@tests/cli/test_main.py
</context>

<acceptance_criteria>

## AC-1: dead-code --exit-code fails on dead code
```gherkin
Given an indexed project with dead code symbols in the graph
When the user runs `axon dead-code --exit-code`
Then the command prints the dead code report
And the exit code is 1
```

## AC-2: dead-code --exit-code succeeds when clean
```gherkin
Given an indexed project with no dead code
When the user runs `axon dead-code --exit-code`
Then the command prints the clean message
And the exit code is 0
```

## AC-3: dead-code without --exit-code always exits 0
```gherkin
Given an indexed project with dead code symbols
When the user runs `axon dead-code` (no --exit-code flag)
Then the dead code report is printed
And the exit code is 0 (backward-compatible — existing behavior unchanged)
```

## AC-4: GitHub Actions template is valid YAML
```gherkin
Given the templates/github-actions.yml file
When parsed as YAML
Then it is valid
And it contains a job that runs `axon analyze`
And it contains a step that runs `axon dead-code --exit-code`
```

## AC-5: pre-commit template is valid YAML
```gherkin
Given the templates/pre-commit-config.yaml file
When parsed as YAML
Then it is valid
And it contains a hook that runs `axon analyze`
And it contains a hook that runs `axon dead-code --exit-code`
```

</acceptance_criteria>

<tasks>

<task type="auto">
  <name>Task 1: Add --exit-code flag to axon dead-code command</name>
  <files>src/axon/cli/main.py</files>
  <action>
    Modify the `dead_code()` function in `src/axon/cli/main.py`:

    Current signature:
    ```python
    @app.command(name="dead-code")
    def dead_code() -> None:
        """List all detected dead code."""
    ```

    New signature:
    ```python
    @app.command(name="dead-code")
    def dead_code(
        exit_code: bool = typer.Option(False, "--exit-code", help="Exit with code 1 if dead code is found (useful for CI)."),
    ) -> None:
        """List all detected dead code."""
    ```

    After printing the result, add exit-code logic:
    ```python
    storage = _load_storage()
    result = handle_dead_code(storage)
    console.print(result)
    storage.close()
    if exit_code and not result.startswith("No dead code"):
        raise typer.Exit(code=1)
    ```

    Detection logic: `get_dead_code_list` returns `"No dead code detected. Codebase looks clean."` when
    clean and `"Dead Code Report (N symbols)\n..."` when dead code found. Check `result.startswith("No dead code")`
    to distinguish — this is the stable contract used by `handle_dead_code`.

    Avoid: modifying the default behavior (no `--exit-code` flag = always exit 0).
    Avoid: importing anything new — `typer` already in scope.
  </action>
  <verify>
    cd /home/dstadel/projects/axon
    uv run axon dead-code --help | grep "exit-code"
  </verify>
  <done>AC-1, AC-2, AC-3 satisfied — exit-code flag controls CI behavior</done>
</task>

<task type="auto">
  <name>Task 2: Add tests for --exit-code flag</name>
  <files>tests/cli/test_main.py</files>
  <action>
    Add tests to the existing `TestDeadCode` class in `tests/cli/test_main.py`:

    - `test_dead_code_exit_code_when_found`:
      - Mock `axon.mcp.tools.handle_dead_code` to return `"Dead Code Report (3 symbols)\n..."`
      - Invoke `["dead-code", "--exit-code"]` with `catch_exceptions=False`
      - Assert `result.exit_code == 1`
      - Assert `"Dead Code Report" in result.output`

    - `test_dead_code_exit_code_when_clean`:
      - Mock `axon.mcp.tools.handle_dead_code` to return `"No dead code detected. Codebase looks clean."`
      - Invoke `["dead-code", "--exit-code"]`
      - Assert `result.exit_code == 0`

    - `test_dead_code_no_flag_exits_zero_even_with_dead_code`:
      - Mock `axon.mcp.tools.handle_dead_code` to return `"Dead Code Report (3 symbols)\n..."`
      - Invoke `["dead-code"]` (no `--exit-code`)
      - Assert `result.exit_code == 0`  (backward compatibility)

    All three tests require `tmp_path` + `monkeypatch.chdir(tmp_path)` + an `.axon/meta.json` stub
    so `_load_storage()` doesn't raise "No index found". Use the same pattern as the existing
    `test_dead_code_with_storage` test.
  </action>
  <verify>
    cd /home/dstadel/projects/axon
    uv run pytest tests/cli/test_main.py::TestDeadCode -v
  </verify>
  <done>AC-1, AC-2, AC-3 verified via test suite — all TestDeadCode tests pass</done>
</task>

<task type="auto">
  <name>Task 3: Create CI template files</name>
  <files>templates/github-actions.yml, templates/pre-commit-config.yaml</files>
  <action>
    Create a `templates/` directory at the project root with two files:

    **`templates/github-actions.yml`** — GitHub Actions workflow template:
    ```yaml
    # Copy to .github/workflows/axon.yml in your project
    # Runs axon code analysis on every push and PR
    name: Axon Code Analysis

    on: [push, pull_request]

    jobs:
      axon-analysis:
        runs-on: ubuntu-latest
        steps:
          - uses: actions/checkout@v4

          - uses: astral-sh/setup-uv@v5
            with:
              python-version: "3.11"

          - name: Install axon
            run: uv pip install axoniq

          - name: Index codebase
            run: axon analyze .

          - name: Check for dead code
            run: axon dead-code --exit-code
    ```

    **`templates/pre-commit-config.yaml`** — pre-commit config snippet:
    ```yaml
    # Merge this snippet into your project's .pre-commit-config.yaml
    # Requires: pip install pre-commit axoniq
    repos:
      - repo: local
        hooks:
          - id: axon-analyze
            name: "Axon: Re-index codebase"
            entry: axon analyze
            language: python
            additional_dependencies: ["axoniq"]
            pass_filenames: false
            always_run: true

          - id: axon-dead-code
            name: "Axon: Check for dead code"
            entry: axon dead-code --exit-code
            language: python
            additional_dependencies: ["axoniq"]
            pass_filenames: false
            always_run: true
    ```

    No test file needed — YAML validity is verified by parsing in the verification step.
    These are reference templates for the docs phase (03-04).
  </action>
  <verify>
    cd /home/dstadel/projects/axon
    python -c "import yaml; yaml.safe_load(open('templates/github-actions.yml')); print('github-actions.yml OK')"
    python -c "import yaml; yaml.safe_load(open('templates/pre-commit-config.yaml')); print('pre-commit-config.yaml OK')"
  </verify>
  <done>AC-4, AC-5 satisfied — both template files exist and are valid YAML</done>
</task>

</tasks>

<boundaries>

## DO NOT CHANGE
- `src/axon/core/` — ingestion pipeline, parsers, storage untouched
- `src/axon/mcp/` — MCP server, tools, and resources untouched
- `src/axon/mcp/resources.py` — `get_dead_code_list()` return format is stable; do not change
- Existing CLI commands in `src/axon/cli/main.py` — only modify `dead_code()`, do not touch others
- Existing tests in `tests/cli/test_main.py` — only add tests to `TestDeadCode`, do not modify existing

## SCOPE LIMITS
- No new CLI commands (no `axon ci` command — `--exit-code` flag on existing command is sufficient)
- No changes to how dead code is detected — only the exit code behavior changes
- Templates are static files — no code generation command for them
- No `--exit-code` flag on `axon analyze` — `analyze` is not a quality gate, it's an indexer
- No `.pre-commit-hooks.yaml` at root (axon is not a hooks REPO, users use `repo: local` pattern)

</boundaries>

<verification>
Before declaring plan complete:
- [ ] `uv run axon dead-code --help` shows `--exit-code` option
- [ ] `uv run pytest tests/cli/test_main.py::TestDeadCode -v` — all tests pass (existing + 3 new)
- [ ] `uv run pytest tests/ -x -q` — full suite still passing (668+ tests)
- [ ] `python -c "import yaml; yaml.safe_load(open('templates/github-actions.yml'))"` — valid YAML
- [ ] `python -c "import yaml; yaml.safe_load(open('templates/pre-commit-config.yaml'))"` — valid YAML
- [ ] `uv run ruff check src/axon/cli/main.py` — no new lint errors introduced
</verification>

<success_criteria>
- `axon dead-code --exit-code` exits 1 when dead code found, 0 when clean
- Backward compat: `axon dead-code` (no flag) always exits 0
- 3 new tests for exit-code behavior, all passing
- Full suite (668+ tests) passing, no regressions
- Both template YAML files created and parseable
</success_criteria>

<output>
After completion, create `.paul/phases/03-workflow-integration/03-02-SUMMARY.md`
</output>
