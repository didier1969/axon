---
phase: 03-workflow-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/axon/cli/main.py
  - tests/cli/test_main.py
autonomous: true
---

<objective>
## Goal
Add `axon shell-hook` and `axon init` CLI commands so developers can auto-start the axon watcher whenever they `cd` into an indexed project.

## Purpose
The current workflow requires manually running `axon watch` or `axon serve --watch` each session. This plan delivers zero-friction session start: the file watcher starts automatically when entering a project directory, keeping the index current without any manual action.

## Output
- `axon shell-hook [--shell bash|zsh]` — prints shell integration code to eval in `.bashrc`/`.zshrc`
- `axon init [--direnv]` — creates/appends the `.envrc` direnv snippet for direnv users
- Tests for both commands
</objective>

<context>
## Project Context
@.paul/PROJECT.md
@.paul/ROADMAP.md
@.paul/STATE.md

## Source Files
@src/axon/cli/main.py
@tests/cli/test_main.py
</context>

<acceptance_criteria>

## AC-1: shell-hook bash output
```gherkin
Given the axon CLI is installed
When the user runs `axon shell-hook --shell bash`
Then stdout contains a bash function named `_axon_chpwd`
And stdout contains `PROMPT_COMMAND`
And stdout contains `axon watch`
And stdout contains `.axon/watch.pid` for process deduplication
And the exit code is 0
```

## AC-2: shell-hook zsh output
```gherkin
Given the axon CLI is installed
When the user runs `axon shell-hook --shell zsh`
Then stdout contains a zsh function named `_axon_chpwd`
And stdout contains `add-zsh-hook chpwd`
And stdout contains `axon watch`
And stdout contains `.axon/watch.pid` for process deduplication
And the exit code is 0
```

## AC-3: shell-hook default (no --shell flag)
```gherkin
Given the axon CLI is installed
When the user runs `axon shell-hook` (no --shell flag)
Then stdout contains valid shell integration code (bash-compatible)
And the exit code is 0
```

## AC-4: init creates .envrc snippet
```gherkin
Given a project directory without a `.envrc` file
When the user runs `axon init --direnv`
Then `.envrc` is created containing `axon watch` auto-start logic
And `.envrc` contains a PID-file guard (`watch.pid`) to prevent duplicate processes
And stdout confirms what was written
And the exit code is 0
```

## AC-5: init --direnv appends to existing .envrc
```gherkin
Given a project directory with an existing `.envrc` file
When the user runs `axon init --direnv`
Then the existing `.envrc` content is preserved
And the axon block is appended (not duplicated if already present)
And the exit code is 0
```

## AC-6: init without --direnv prints instructions
```gherkin
Given the axon CLI is installed
When the user runs `axon init` (without --direnv)
Then stdout shows setup instructions for both shell-hook and direnv approaches
And the exit code is 0
```

</acceptance_criteria>

<tasks>

<task type="auto">
  <name>Task 1: Add `axon shell-hook` and `axon init` commands to CLI</name>
  <files>src/axon/cli/main.py</files>
  <action>
    Add two new commands to the Typer app in `src/axon/cli/main.py`:

    **Command 1: `axon shell-hook`**
    ```python
    @app.command(name="shell-hook")
    def shell_hook(
        shell: str = typer.Option("bash", "--shell", "-s", help="Shell type: bash or zsh."),
    ) -> None:
        """Print shell integration code to auto-start axon watcher on cd."""
    ```
    - Accepts `--shell bash` (default) or `--shell zsh`
    - Prints to stdout (use `print()` not `console.print()` — stdout must be clean for eval)
    - For bash: outputs `_axon_chpwd()` function + `PROMPT_COMMAND` hook
    - For zsh: outputs `_axon_chpwd()` function + `autoload -U add-zsh-hook; add-zsh-hook chpwd _axon_chpwd`
    - The function body (same for both shells):
      1. Check if `.axon/` directory exists in cwd — if not, return silently
      2. Check PID file `.axon/watch.pid` — if file exists and process is alive (`kill -0`), return (already running)
      3. Launch `axon watch >/dev/null 2>&1 &` in background
      4. Write PID to `.axon/watch.pid`
    - Add a comment header: `# Axon shell integration — eval "$(axon shell-hook)"`
    - Raise `typer.Exit(code=1)` with error message if shell is not "bash" or "zsh"

    **Command 2: `axon init`**
    ```python
    @app.command()
    def init(
        direnv: bool = typer.Option(False, "--direnv", help="Create/update .envrc with axon auto-start."),
    ) -> None:
        """Initialize axon integration for the current project."""
    ```
    - When `--direnv` not given: print instructions showing both approaches (shell-hook + direnv)
    - When `--direnv` given:
      1. Read existing `.envrc` if present (don't overwrite other content)
      2. Define a sentinel: `# >>> axon auto-start <<<`
      3. If sentinel already present in `.envrc`: print "Axon block already in .envrc — skipping." and exit 0
      4. If not present: append the direnv block to `.envrc`:
         ```bash
         # >>> axon auto-start <<<
         if command -v axon >/dev/null 2>&1 && [[ -d ".axon" ]]; then
           _axon_pid_file=".axon/watch.pid"
           if ! { [[ -f "$_axon_pid_file" ]] && kill -0 "$(cat "$_axon_pid_file")" 2>/dev/null; }; then
             axon watch >/dev/null 2>&1 &
             echo $! > "$_axon_pid_file"
           fi
         fi
         # <<< axon auto-start <<<
         ```
      5. Print confirmation: "Added axon auto-start block to .envrc"
      6. If direnv is installed (check `shutil.which("direnv")`), print reminder: "Run `direnv allow` to activate."

    Avoid: using `console.print()` for the `shell-hook` command output (must be eval-safe stdout).
  </action>
  <verify>
    cd /home/dstadel/projects/axon
    uv run axon shell-hook --shell bash | head -5
    uv run axon shell-hook --shell zsh | head -5
    uv run axon init
  </verify>
  <done>AC-1, AC-2, AC-3, AC-4, AC-5, AC-6 satisfied</done>
</task>

<task type="auto">
  <name>Task 2: Add tests for shell-hook and init commands</name>
  <files>tests/cli/test_main.py</files>
  <action>
    Add two new test classes to `tests/cli/test_main.py` using the existing `runner = CliRunner()` and `app` import pattern:

    **Class `TestShellHook`:**
    - `test_shell_hook_bash_exit_code`: invoke `["shell-hook", "--shell", "bash"]`, assert exit_code == 0
    - `test_shell_hook_bash_contains_function`: assert `"_axon_chpwd"` in output
    - `test_shell_hook_bash_contains_prompt_command`: assert `"PROMPT_COMMAND"` in output
    - `test_shell_hook_bash_contains_axon_watch`: assert `"axon watch"` in output
    - `test_shell_hook_bash_contains_pid_file`: assert `"watch.pid"` in output
    - `test_shell_hook_zsh_exit_code`: invoke `["shell-hook", "--shell", "zsh"]`, assert exit_code == 0
    - `test_shell_hook_zsh_contains_add_zsh_hook`: assert `"add-zsh-hook"` in output
    - `test_shell_hook_zsh_contains_axon_watch`: assert `"axon watch"` in output
    - `test_shell_hook_default`: invoke `["shell-hook"]` (no --shell), assert exit_code == 0 and `"axon watch"` in output
    - `test_shell_hook_invalid_shell`: invoke `["shell-hook", "--shell", "fish"]`, assert exit_code != 0

    **Class `TestInit`:**
    - `test_init_no_args_exit_code`: invoke `["init"]`, assert exit_code == 0
    - `test_init_no_args_shows_instructions`: assert `"shell-hook"` in output and `"direnv"` in output
    - `test_init_direnv_creates_envrc` (uses `tmp_path` fixture via monkeypatch/chdir):
      - Change cwd to a temp dir
      - Invoke `["init", "--direnv"]`
      - Assert exit_code == 0
      - Assert `.envrc` was created in tmp dir
      - Assert `"axon auto-start"` in `.envrc` content
      - Assert `"axon watch"` in `.envrc` content
    - `test_init_direnv_appends_to_existing_envrc`:
      - Write a pre-existing `.envrc` with content `"export FOO=bar\n"` in tmp dir
      - Invoke `["init", "--direnv"]`
      - Assert original content preserved
      - Assert `"axon watch"` appended
    - `test_init_direnv_idempotent`:
      - Run `["init", "--direnv"]` twice in the same tmp dir
      - Assert `"axon auto-start"` appears exactly once in `.envrc` (no duplication)

    Use `runner.invoke(app, args, catch_exceptions=False)` for cleaner failures.
    For tests needing a temp directory, use the `typer.testing.CliRunner(mix_stderr=False)` and `os.chdir` or `runner.invoke(..., env={"PWD": str(tmp_path)})` — but simplest is to use `tmp_path` with `monkeypatch.chdir(tmp_path)` via pytest fixture.
  </action>
  <verify>
    cd /home/dstadel/projects/axon
    uv run pytest tests/cli/test_main.py::TestShellHook tests/cli/test_main.py::TestInit -v
  </verify>
  <done>All TestShellHook and TestInit tests pass; AC-1 through AC-6 verified via test suite</done>
</task>

</tasks>

<boundaries>

## DO NOT CHANGE
- `src/axon/core/` — ingestion pipeline, parsers, storage untouched
- `src/axon/mcp/` — MCP server and tools untouched
- Existing CLI commands in `src/axon/cli/main.py` — do not modify any existing command
- Existing tests in `tests/cli/test_main.py` — only add, do not modify existing tests

## SCOPE LIMITS
- This plan is CLI commands only — no changes to watch logic, pipeline, or MCP
- No changes to `pyproject.toml` — shell-hook and init are pure CLI, no new deps
- Do not implement fish shell support (only bash and zsh)
- `axon init` without `--direnv` is informational only — no file creation

</boundaries>

<verification>
Before declaring plan complete:
- [ ] `uv run axon shell-hook --shell bash` outputs eval-safe bash code with `_axon_chpwd` and `PROMPT_COMMAND`
- [ ] `uv run axon shell-hook --shell zsh` outputs zsh code with `add-zsh-hook`
- [ ] `uv run axon init` prints setup instructions without error
- [ ] `uv run axon init --direnv` creates `.envrc` with axon block (test in /tmp)
- [ ] `uv run pytest tests/cli/test_main.py::TestShellHook tests/cli/test_main.py::TestInit -v` — all pass
- [ ] `uv run pytest tests/ -x -q` — full suite still passing (652 tests + new ones)
- [ ] `uv run ruff check src/axon/cli/main.py tests/cli/test_main.py` — no lint errors
</verification>

<success_criteria>
- Both commands added to CLI with correct behavior
- All new tests pass
- Full test suite passes (no regressions)
- Shell output is eval-safe (no Rich markup, pure text)
- Direnv `.envrc` block is idempotent (safe to run `axon init --direnv` multiple times)
</success_criteria>

<output>
After completion, create `.paul/phases/03-workflow-integration/03-01-SUMMARY.md`
</output>
