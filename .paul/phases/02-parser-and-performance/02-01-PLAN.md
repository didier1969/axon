---
phase: 02-parser-and-performance
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/axon/core/graph/model.py
  - src/axon/core/ingestion/heritage.py
  - tests/core/test_parser_elixir.py
  - tests/core/test_heritage.py
autonomous: true
---

<objective>
## Goal
Fix Elixir `use Module` directives so they create a `USES` relationship in the
knowledge graph instead of being silently dropped with a warning.

## Purpose
Every Elixir project using Phoenix, Ecto, or any framework emits `use Phoenix.Controller`,
`use Ecto.Schema`, etc. These are architecturally significant relationships (macro injection,
framework adoption) currently invisible in the graph. Every cold-start on an Elixir project
logs "Unknown heritage kind 'uses' for …" — a clear signal this is a known bug.

## Output
- `RelType.USES` added to the graph model
- `"uses"` mapped to `RelType.USES` in heritage processor
- 2 new test cases: parser level + ingestion level
</objective>

<context>
## Project Context
@.paul/PROJECT.md
@.paul/STATE.md

## Source Files
@src/axon/core/graph/model.py
@src/axon/core/ingestion/heritage.py
@src/axon/core/parsers/elixir_lang.py
@tests/core/test_parser_elixir.py
@tests/core/test_heritage.py

## Root Cause Analysis
The parser is CORRECT: `elixir_lang.py:305` already emits
`result.heritage.append((module_name, "uses", module_alias))`.

The bug is in two places downstream:
1. `model.py` — `RelType` has no `USES` member (closest is `USES_TYPE` which is different)
2. `heritage.py:82` — `_KIND_TO_REL` only maps `"extends"` and `"implements"`; `"uses"` hits
   the `if rel_type is None` branch → warning logged → relationship skipped

Fix is minimal: 2 lines of code across 2 files.
</context>

<acceptance_criteria>

## AC-1: `RelType.USES` exists in the model
```gherkin
Given the axon graph model
When RelType is imported
Then `RelType.USES` exists with value `"uses"`
```

## AC-2: Parser emits `"uses"` heritage tuples for Elixir `use` directives
```gherkin
Given an Elixir file containing `use GenServer`
When ElixirParser.parse() is called
Then `result.heritage` contains `("MyModule", "uses", "GenServer")`
```

## AC-3: Heritage processor creates `USES` relationship
```gherkin
Given a graph with CLASS nodes for `MyServer` and `GenServer`
And a heritage tuple `("MyServer", "uses", "GenServer")`
When process_heritage() is called
Then a USES relationship exists from MyServer → GenServer
```

## AC-4: Unresolvable `use` target is silently skipped (no warning)
```gherkin
Given a heritage tuple ("MyModule", "uses", "ExternalLib.Macro")
And ExternalLib.Macro is not in the graph (external dependency)
When process_heritage() is called
Then no USES relationship is created
And no "Unknown heritage kind" warning is logged
```

## AC-5: All 752 existing tests still pass
```gherkin
Given the test suite at the pre-plan baseline
When `uv run pytest tests/` is run
Then all 752 tests pass with no new failures
```

</acceptance_criteria>

<tasks>

<task type="auto">
  <name>Task 1: Add RelType.USES and map it in heritage processor</name>
  <files>src/axon/core/graph/model.py, src/axon/core/ingestion/heritage.py</files>
  <action>
    In `model.py`, add `USES = "uses"` to the `RelType` enum after `IMPLEMENTS`:
    ```python
    IMPLEMENTS = "implements"
    USES = "uses"          # ← add this line
    ```

    In `heritage.py`, add `"uses": RelType.USES` to `_KIND_TO_REL`:
    ```python
    _KIND_TO_REL: dict[str, RelType] = {
        "extends": RelType.EXTENDS,
        "implements": RelType.IMPLEMENTS,
        "uses": RelType.USES,   # ← add this line
    }
    ```

    No other changes. Do NOT change `_HERITAGE_LABELS` (already includes CLASS,
    which is the label for Elixir modules). Do NOT change the parser.
  </action>
  <verify>
    ```bash
    uv run python -c "from axon.core.graph.model import RelType; print(RelType.USES)"
    uv run python -c "from axon.core.ingestion.heritage import _KIND_TO_REL; print(_KIND_TO_REL)"
    ```
    Both commands succeed without ImportError.
  </verify>
  <done>AC-1 satisfied: RelType.USES exists and is mapped in heritage processor</done>
</task>

<task type="auto">
  <name>Task 2: Add parser-level and ingestion-level tests for Elixir `use`</name>
  <files>tests/core/test_parser_elixir.py, tests/core/test_heritage.py</files>
  <action>
    In `test_parser_elixir.py`, add a new test class `TestParseUseDirective` after
    the existing import tests (find the class testing `alias`/`import` if any, or add
    at end of file):

    ```python
    class TestParseUseDirective:
        """use MyModule produces a heritage tuple."""

        CODE = """\
    defmodule MyApp.Server do
      use GenServer
    end
    """

        def test_use_produces_heritage_tuple(self, parser: ElixirParser) -> None:
            result = parser.parse(self.CODE, "server.ex")
            assert ("MyApp.Server", "uses", "GenServer") in result.heritage

        def test_use_also_produces_import(self, parser: ElixirParser) -> None:
            result = parser.parse(self.CODE, "server.ex")
            imported_modules = [i.module for i in result.imports]
            assert "GenServer" in imported_modules
    ```

    In `test_heritage.py`, add a new test class `TestProcessHeritageUses` after
    `TestProcessHeritageImplements`. The test graph fixture already has CLASS nodes
    for Animal and Dog — add a GenServer node and verify USES relationship:

    ```python
    class TestProcessHeritageUses:
        """Elixir use MyModule creates a USES relationship."""

        def test_process_heritage_uses(self, graph: KnowledgeGraph) -> None:
            # Add two Elixir module nodes (stored as CLASS)
            graph.add_node(
                GraphNode(
                    id=generate_id(NodeLabel.CLASS, "lib/server.ex", "MyServer"),
                    label=NodeLabel.CLASS,
                    name="MyServer",
                    file_path="lib/server.ex",
                )
            )
            graph.add_node(
                GraphNode(
                    id=generate_id(NodeLabel.CLASS, "lib/gen_server.ex", "GenServer"),
                    label=NodeLabel.CLASS,
                    name="GenServer",
                    file_path="lib/gen_server.ex",
                )
            )
            parse_data = [
                _make_parse_data(
                    "lib/server.ex",
                    [("MyServer", "uses", "GenServer")],
                )
            ]
            process_heritage(parse_data, graph)

            uses_rels = graph.get_relationships_by_type(RelType.USES)
            assert len(uses_rels) == 1
            rel = uses_rels[0]
            assert rel.source == generate_id(NodeLabel.CLASS, "lib/server.ex", "MyServer")
            assert rel.target == generate_id(NodeLabel.CLASS, "lib/gen_server.ex", "GenServer")

        def test_uses_unresolved_external_skipped(self, graph: KnowledgeGraph) -> None:
            """use ExternalLib.Macro (not in graph) is silently skipped."""
            graph.add_node(
                GraphNode(
                    id=generate_id(NodeLabel.CLASS, "lib/server.ex", "MyServer"),
                    label=NodeLabel.CLASS,
                    name="MyServer",
                    file_path="lib/server.ex",
                )
            )
            parse_data = [
                _make_parse_data(
                    "lib/server.ex",
                    [("MyServer", "uses", "Phoenix.Controller")],
                )
            ]
            process_heritage(parse_data, graph)

            uses_rels = graph.get_relationships_by_type(RelType.USES)
            assert len(uses_rels) == 0
    ```

    Ensure `RelType.USES` is imported in `test_heritage.py` (it already imports
    `RelType` so just add to the existing import).
  </action>
  <verify>
    ```bash
    uv run pytest tests/core/test_parser_elixir.py -v -k "Use"
    uv run pytest tests/core/test_heritage.py -v -k "Uses"
    ```
    All new tests pass.
  </verify>
  <done>AC-2, AC-3, AC-4 satisfied: parser and ingestion tests pass for USES relationship</done>
</task>

<task type="auto">
  <name>Task 3: Verify full test suite still passes</name>
  <files>(no changes)</files>
  <action>
    Run the full test suite and confirm all tests pass. Do not modify any files in
    this task — it is verification only.
    ```bash
    uv run pytest tests/ -q
    ```
  </action>
  <verify>
    Output ends with `752 passed` or higher (new tests added = total > 752).
    Zero failures, zero errors.
  </verify>
  <done>AC-5 satisfied: full suite passes</done>
</task>

</tasks>

<boundaries>

## DO NOT CHANGE
- `src/axon/core/parsers/elixir_lang.py` — parser is already correct, no changes needed
- `src/axon/core/ingestion/symbol_lookup.py` — lookup logic unchanged
- Any test not listed in `files_modified` above

## SCOPE LIMITS
- This plan only fixes the `use` directive → USES relationship gap
- Do NOT add USES relationships for other languages
- Do NOT change how `alias`, `import`, or `require` are handled
- Do NOT refactor the heritage module beyond the minimal 2-line fix

</boundaries>

<verification>
Before declaring plan complete:
- [ ] `uv run python -c "from axon.core.graph.model import RelType; assert RelType.USES.value == 'uses'"` passes
- [ ] `uv run pytest tests/core/test_parser_elixir.py -v -k "Use"` — new tests pass
- [ ] `uv run pytest tests/core/test_heritage.py -v -k "Uses"` — new tests pass
- [ ] `uv run pytest tests/ -q` — all tests pass (≥752, zero failures)
</verification>

<success_criteria>
- `RelType.USES = "uses"` added to model
- `"uses": RelType.USES` added to `_KIND_TO_REL` in heritage.py
- 4 new tests added (2 parser-level, 2 ingestion-level)
- All existing 752 tests still pass
- No "Unknown heritage kind 'uses'" warnings in logs
</success_criteria>

<output>
After completion, create `.paul/phases/02-parser-and-performance/02-01-SUMMARY.md`
</output>
